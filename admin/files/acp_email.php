<?php

/**
**********************
** BTManager v3.0.2 **
**********************
** http://www.btmanager.org/
** https://github.com/blackheart1/BTManager3.0.2
** http://demo.btmanager.org/index.php
** Licence Info: GPL
** Copyright (C) 2018
** Formerly Known As phpMyBitTorrent
** Created By Antonio Anzivino (aka DJ Echelon)
** And Joe Robertson (aka joeroberts/Black_Heart)
** Project Leaders: Black_Heart, Thor.
** File files/acp_email.php 2018-09-22 00:00:00 Thor
**
** CHANGES
**
** 2018-09-22 - Updated Masthead, Github, !defined('IN_BTM')
**/

if (!defined('IN_BTM'))
{
    require_once($_SERVER['DOCUMENT_ROOT'].'/security.php');
    die ("Error 404 - Page Not Found");
}

class acp_email
{
    var $u_action;
    var $new_config = array();

    function main($id, $mode)
    {
        global $db, $user, $auth, $template;
        global $config,$db_prefix, $phpbb_root_path, $phpbb_admin_path, $phpEx;
        global $cache;

        $user->set_lang('admin/acp_email',$user->ulanguage);

        $action = request_var('action', '');
        $submit = (isset($_POST['submit']) || isset($_POST['allow_quick_reply_enable'])) ? true : false;

        $form_key = 'acp_email';
        add_form_key($form_key);

        /**
        *   Validation types are:
        *       string, int, bool,
        *       script_path (absolute path in url - beginning with / and no trailing slash),
        *       rpath (relative), rwpath (realtive, writable), path (relative path, but able to escape the root), wpath (writable)
        */
                $display_vars = array(
                    'title' => 'ACP_EMAIL_SETTINGS',
                    'vars'  => array(
                        'legend'               => 'GENERAL_SETTINGS',
                        'email_enable'          => array('lang' => 'ENABLE_EMAIL',          'validate' => 'bool',   'type' => 'radio:enabled_disabled', 'explain' => true),
                        'board_email_form'      => array('lang' => 'BOARD_EMAIL_FORM',      'validate' => 'bool',   'type' => 'radio:enabled_disabled', 'explain' => true),
                        'email_function_name'   => array('lang' => 'EMAIL_FUNCTION_NAME',   'validate' => 'string', 'type' => 'text:20:50', 'explain' => true),
                        'email_package_size'    => array('lang' => 'EMAIL_PACKAGE_SIZE',    'validate' => 'int:0',  'type' => 'text:5:5', 'explain' => true),
                        'board_contact'         => array('lang' => 'CONTACT_EMAIL',         'validate' => 'email',  'type' => 'text:25:100', 'explain' => true),
                        'board_email'           => array('lang' => 'ADMIN_EMAIL',           'validate' => 'email',  'type' => 'text:25:100', 'explain' => true),
                        'board_email_sig'       => array('lang' => 'EMAIL_SIG',             'validate' => 'string', 'type' => 'textarea:5:30', 'explain' => true),
                        'board_hide_emails'     => array('lang' => 'BOARD_HIDE_EMAILS',     'validate' => 'bool',   'type' => 'radio:yes_no', 'explain' => true),
                        'allow_topic_notify'    => array('lang' => 'ALLOW_TOPIC_NOTIFY',    'validate' => 'bool',   'type' => 'radio:yes_no', 'explain' => false),

                        'legend2'               => 'SMTP_SETTINGS',
                        'smtp_delivery_ssl'     => array('lang' => 'USE_SMTP_SSL',          'validate' => 'string', 'type' => 'select', 'method' => 'mail_auth_ssl_select', 'explain' => true),
                        'smtp_authentication'   => array('lang' => 'USE_AUTHEN',            'validate' => 'bool',   'type' => 'radio:yes_no', 'explain' => true),
                        'smtp_debug'            => array('lang' => 'USE_DEBUGING',          'validate' => 'bool',   'type' => 'radio:yes_no', 'explain' => true),
                        'smtp_delivery'         => array('lang' => 'USE_SMTP',              'validate' => 'bool',   'type' => 'radio:yes_no', 'explain' => true),
                        'smtp_host'             => array('lang' => 'SMTP_SERVER',           'validate' => 'string', 'type' => 'text:25:50', 'explain' => true),
                        'smtp_port'             => array('lang' => 'SMTP_PORT',             'validate' => 'int:0',  'type' => 'text:4:5', 'explain' => true),
                        'smtp_auth_method'      => array('lang' => 'SMTP_AUTH_METHOD',      'validate' => 'string', 'type' => 'select', 'method' => 'mail_auth_select', 'explain' => true),
                        'smtp_username'         => array('lang' => 'SMTP_USERNAME',         'validate' => 'string', 'type' => 'text:25:255', 'explain' => true),
                        'smtp_password'         => array('lang' => 'SMTP_PASSWORD',         'validate' => 'string', 'type' => 'password:25:255', 'explain' => true),

                        'legend3'                   => 'ACP_SUBMIT_CHANGES',
                    )
                );
        $this->new_config = $config;
        $cfg_array = (isset($_REQUEST['config'])) ? utf8_normalize_nfc(request_var('config', array('' => ''), true)) : $this->new_config;
        $error = array();

        // We validate the complete config if whished
        validate_config_vars($display_vars['vars'], $cfg_array, $error);

        if ($submit && !check_form_key($form_key))
        {
            $error[] = $user->lang['FORM_INVALID']. 'invalid';
        }
        // Do not write values if there is an error
        if (sizeof($error))
        {
            $submit = false;
        }

        // We go through the display_vars to make sure no one is trying to set variables he/she is not allowed to...
        foreach ($display_vars['vars'] as $config_name => $null)
        {
            if (!isset($cfg_array[$config_name]) || strpos($config_name, 'legend') !== false)
            {
                continue;
            }

            if ($config_name == 'auth_method' || $config_name == 'feed_news_id' || $config_name == 'feed_exclude_id')
            {
                continue;
            }

            $this->new_config[$config_name] = $config_value = $cfg_array[$config_name];

            if ($config_name == 'email_function_name')
            {
                $this->new_config['email_function_name'] = trim(str_replace(array('(', ')'), array('', ''), $this->new_config['email_function_name']));
                $this->new_config['email_function_name'] = (empty($this->new_config['email_function_name']) || !function_exists($this->new_config['email_function_name'])) ? 'mail' : $this->new_config['email_function_name'];
                $config_value = $this->new_config['email_function_name'];
            }

            if ($submit)
            {
                set_config($config_name, $config_value);

                if ($config_name == 'allow_quick_reply' && isset($_POST['allow_quick_reply_enable']))
                {
                    enable_bitfield_column_flag(FORUMS_TABLE, 'forum_flags', log(FORUM_FLAG_QUICK_REPLY, 2));
                }
            }
        }

        // Store news and exclude ids
        if ($mode == 'feed' && $submit)
        {
            $cache->destroy('_feed_news_forum_ids');
            $cache->destroy('_feed_excluded_forum_ids');

            $this->store_feed_forums(FORUM_OPTION_FEED_NEWS, 'feed_news_id');
            $this->store_feed_forums(FORUM_OPTION_FEED_EXCLUDE, 'feed_exclude_id');
        }

        if ($mode == 'auth')
        {
            // Retrieve a list of auth plugins and check their config values
            $auth_plugins = array();

            $dp = @opendir($phpbb_root_path . 'includes/auth');

            if ($dp)
            {
                while (($file = readdir($dp)) !== false)
                {
                    if (preg_match('#^auth_(.*?)\.' . $phpEx . '$#', $file))
                    {
                        $auth_plugins[] = basename(preg_replace('#^auth_(.*?)\.' . $phpEx . '$#', '\1', $file));
                    }
                }
                closedir($dp);

                sort($auth_plugins);
            }

            $updated_auth_settings = false;
            $old_auth_config = array();
            foreach ($auth_plugins as $method)
            {
                if ($method && file_exists($phpbb_root_path . 'include/auth/auth_' . $method . '.' . $phpEx))
                {
                    include_once($phpbb_root_path . 'include/auth/auth_' . $method . '.' . $phpEx);

                    $method = 'acp_' . $method;
                    if (function_exists($method))
                    {
                        if ($fields = $method($this->new_config))
                        {
                            // Check if we need to create config fields for this plugin and save config when submit was pressed
                            foreach ($fields['config'] as $field)
                            {
                                if (!isset($config[$field]))
                                {
                                    set_config($field, '');
                                }

                                if (!isset($cfg_array[$field]) || strpos($field, 'legend') !== false)
                                {
                                    continue;
                                }

                                $old_auth_config[$field] = $this->new_config[$field];
                                $config_value = $cfg_array[$field];
                                $this->new_config[$field] = $config_value;

                                if ($submit)
                                {
                                    $updated_auth_settings = true;
                                    set_config($field, $config_value);
                                }
                            }
                        }
                        unset($fields);
                    }
                }
            }

            if ($submit && (($cfg_array['auth_method'] != $this->new_config['auth_method']) || $updated_auth_settings))
            {
                $method = basename($cfg_array['auth_method']);
                if ($method && in_array($method, $auth_plugins))
                {
                    include_once($phpbb_root_path . 'include/auth/auth_' . $method . '.' . $phpEx);

                    $method = 'init_' . $method;
                    if (function_exists($method))
                    {
                        if ($error = $method())
                        {
                            foreach ($old_auth_config as $config_name => $config_value)
                            {
                                set_config($config_name, $config_value);
                            }
                            trigger_error($error . '1' . adm_back_link($this->u_action), E_USER_WARNING);
                        }
                    }
                    set_config('auth_method', basename($cfg_array['auth_method']));
                }
                else
                {
                    trigger_error('NO_AUTH_PLUGIN', E_USER_ERROR);
                }
            }
        }

        if ($submit)
        {
            add_log('admin', 'LOG_CONFIG_EMAIL');

            trigger_error($user->lang['CONFIG_UPDATED_EMAIL'] . adm_back_link($this->u_action));
        }

        $this->tpl_name = 'acp_email';
        $this->page_title = $display_vars['title'];

        $template->assign_vars(array(
            'L_TITLE'           => $user->lang[$display_vars['title']],
            'L_TITLE_EXPLAIN'   => $user->lang[$display_vars['title'] . '_EXPLAIN'],

            'S_ERROR'           => (sizeof($error)) ? true : false,
            'ERROR_MSG'         => implode('<br />', $error),

            'U_ACTION'          => $this->u_action)
        );

        // Output relevant page
        foreach ($display_vars['vars'] as $config_key => $vars)
        {
            if (!is_array($vars) && strpos($config_key, 'legend') === false)
            {
                continue;
            }

            if (strpos($config_key, 'legend') !== false)
            {
                $template->assign_block_vars('options', array(
                    'S_LEGEND'      => true,
                    'LEGEND'        => (isset($user->lang[$vars])) ? $user->lang[$vars] : $vars)
                );

                continue;
            }

            $type = explode(':', $vars['type']);

            $l_explain = '';
            if ($vars['explain'] && isset($vars['lang_explain']))
            {
                $l_explain = (isset($user->lang[$vars['lang_explain']])) ? $user->lang[$vars['lang_explain']] : $vars['lang_explain'];
            }
            else if ($vars['explain'])
            {
                $l_explain = (isset($user->lang[$vars['lang'] . '_EXPLAIN'])) ? $user->lang[$vars['lang'] . '_EXPLAIN'] : '';
            }

            $content = build_cfg_template($type, $config_key, $this->new_config, $config_key, $vars);

            if (empty($content))
            {
                continue;
            }

            $template->assign_block_vars('options', array(
                'KEY'           => $config_key,
                'TITLE'         => (isset($user->lang[$vars['lang']])) ? $user->lang[$vars['lang']] : $vars['lang'],
                'S_EXPLAIN'     => $vars['explain'],
                'TITLE_EXPLAIN' => $l_explain,
                'CONTENT'       => $content,
                )
            );

            unset($display_vars['vars'][$config_key]);
        }

        if ($mode == 'auth')
        {
            $template->assign_var('S_AUTH', true);

            foreach ($auth_plugins as $method)
            {
                if ($method && file_exists($phpbb_root_path . 'include/auth/auth_' . $method . '.' . $phpEx))
                {
                    $method = 'acp_' . $method;
                    if (function_exists($method))
                    {
                        $fields = $method($this->new_config);

                        if ($fields['tpl'])
                        {
                            $template->assign_block_vars('auth_tpl', array(
                                'TPL'   => $fields['tpl'])
                            );
                        }
                        unset($fields);
                    }
                }
            }
        }
    }

    /**
    * Select auth method
    */
    function select_auth_method($selected_method, $key = '')
    {
        global $phpbb_root_path, $phpEx;

        $auth_plugins = array();

        $dp = @opendir($phpbb_root_path . 'include/auth');

        if (!$dp)
        {
            return '';
        }

        while (($file = readdir($dp)) !== false)
        {
            if (preg_match('#^auth_(.*?)\.' . $phpEx . '$#', $file))
            {
                $auth_plugins[] = preg_replace('#^auth_(.*?)\.' . $phpEx . '$#', '\1', $file);
            }
        }
        closedir($dp);

        sort($auth_plugins);

        $auth_select = '';
        foreach ($auth_plugins as $method)
        {
            $selected = ($selected_method == $method) ? ' selected="selected"' : '';
            $auth_select .= '<option value="' . $method . '"' . $selected . '>' . ucfirst($method) . '</option>';
        }

        return $auth_select;
    }

    /**
    * Select mail authentication method
    */
    function mail_auth_ssl_select($selected_method, $key = '')
    {
        global $user;

        $auth_methods = array('NONE', 'TLS', 'SSL', 'AUTO');
        $s_smtp_auth_options = '';

        foreach ($auth_methods as $method)
        {
            $s_smtp_auth_options .= '<option value="' . $method . '"' . (($selected_method == $method) ? ' selected="selected"' : '') . '>' . $user->lang['SMTP_SSL_' . str_replace('-', '_', $method)] . '</option>';
        }

        return $s_smtp_auth_options;
    }
    function mail_auth_select($selected_method, $key = '')
    {
        global $user;

        $auth_methods = array('PLAIN', 'LOGIN', 'CRAM-MD5', 'NTLM');
        $s_smtp_auth_options = '';

        foreach ($auth_methods as $method)
        {
            $s_smtp_auth_options .= '<option value="' . $method . '"' . (($selected_method == $method) ? ' selected="selected"' : '') . '>' . $user->lang['SMTP_' . str_replace('-', '_', $method)] . '</option>';
        }

        return $s_smtp_auth_options;
    }

    /**
    * Select full folder action
    */
    function full_folder_select($value, $key = '')
    {
        global $user;

        return '<option value="1"' . (($value == 1) ? ' selected="selected"' : '') . '>' . $user->lang['DELETE_OLDEST_MESSAGES'] . '</option><option value="2"' . (($value == 2) ? ' selected="selected"' : '') . '>' . $user->lang['HOLD_NEW_MESSAGES_SHORT'] . '</option>';
    }

    /**
    * Select ip validation
    */
    function select_ip_check($value, $key = '')
    {
        $radio_ary = array(4 => 'ALL', 3 => 'CLASS_C', 2 => 'CLASS_B', 0 => 'NO_IP_VALIDATION');

        return h_radio('config[ip_check]', $radio_ary, $value, $key);
    }

    /**
    * Select referer validation
    */
    function select_ref_check($value, $key = '')
    {
        $radio_ary = array(2 => 'REF_PATH', 1 => 'REF_HOST', 0 => 'NO_REF_VALIDATION');

        return h_radio('config[referer_validation]', $radio_ary, $value, $key);
    }

    /**
    * Select account activation method
    */
    function select_acc_activation($selected_value, $value)
    {
        global $user, $config;

        $act_ary = array(
          'ACC_DISABLE' => 3,
          'ACC_NONE' => 0,
        );
        if ($config['email_enable'])
        {
            $act_ary['ACC_USER'] = 1;
            $act_ary['ACC_ADMIN'] = 2;
        }
        $act_options = '';

        foreach ($act_ary as $key => $value)
        {
            $selected = ($selected_value == $value) ? ' selected="selected"' : '';
            $act_options .= '<option value="' . $value . '"' . $selected . '>' . $user->lang[$key] . '</option>';
        }

        return $act_options;
    }

    /**
    * Maximum/Minimum username length
    */
    function username_length($value, $key = '')
    {
        global $user;

        return '<input id="' . $key . '" type="text" size="3" maxlength="3" name="config[min_name_chars]" value="' . $value . '" /> ' . $user->lang['MIN_CHARS'] . '&nbsp;&nbsp;<input type="text" size="3" maxlength="3" name="config[max_name_chars]" value="' . $this->new_config['max_name_chars'] . '" /> ' . $user->lang['MAX_CHARS'];
    }

    /**
    * Allowed chars in usernames
    */
    function select_username_chars($selected_value, $key)
    {
        global $user;

        $user_char_ary = array('USERNAME_CHARS_ANY', 'USERNAME_ALPHA_ONLY', 'USERNAME_ALPHA_SPACERS', 'USERNAME_LETTER_NUM', 'USERNAME_LETTER_NUM_SPACERS', 'USERNAME_ASCII');
        $user_char_options = '';
        foreach ($user_char_ary as $user_type)
        {
            $selected = ($selected_value == $user_type) ? ' selected="selected"' : '';
            $user_char_options .= '<option value="' . $user_type . '"' . $selected . '>' . $user->lang[$user_type] . '</option>';
        }

        return $user_char_options;
    }

    /**
    * Maximum/Minimum password length
    */
    function password_length($value, $key)
    {
        global $user;

        return '<input id="' . $key . '" type="text" size="3" maxlength="3" name="config[min_pass_chars]" value="' . $value . '" /> ' . $user->lang['MIN_CHARS'] . '&nbsp;&nbsp;<input type="text" size="3" maxlength="3" name="config[max_pass_chars]" value="' . $this->new_config['max_pass_chars'] . '" /> ' . $user->lang['MAX_CHARS'];
    }

    /**
    * Required chars in passwords
    */
    function select_password_chars($selected_value, $key)
    {
        global $user;

        $pass_type_ary = array('PASS_TYPE_ANY', 'PASS_TYPE_CASE', 'PASS_TYPE_ALPHA', 'PASS_TYPE_SYMBOL');
        $pass_char_options = '';
        foreach ($pass_type_ary as $pass_type)
        {
            $selected = ($selected_value == $pass_type) ? ' selected="selected"' : '';
            $pass_char_options .= '<option value="' . $pass_type . '"' . $selected . '>' . $user->lang[$pass_type] . '</option>';
        }

        return $pass_char_options;
    }

    /**
    * Select bump interval
    */
    function bump_interval($value, $key)
    {
        global $user;

        $s_bump_type = '';
        $types = array('m' => 'MINUTES', 'h' => 'HOURS', 'd' => 'DAYS');
        foreach ($types as $type => $lang)
        {
            $selected = ($this->new_config['bump_type'] == $type) ? ' selected="selected"' : '';
            $s_bump_type .= '<option value="' . $type . '"' . $selected . '>' . $user->lang[$lang] . '</option>';
        }

        return '<input id="' . $key . '" type="text" size="3" maxlength="4" name="config[bump_interval]" value="' . $value . '" />&nbsp;<select name="config[bump_type]">' . $s_bump_type . '</select>';
    }

    /**
    * Board disable option and message
    */
    function board_disable($value, $key)
    {
        global $user;

        $radio_ary = array(1 => 'YES', 0 => 'NO');

        return h_radio('config[board_disable]', $radio_ary, $value) . '<br /><input id="' . $key . '" type="text" name="config[board_disable_msg]" maxlength="255" size="40" value="' . $this->new_config['board_disable_msg'] . '" />';
    }

    /**
    * Global quick reply enable/disable setting and button to enable in all forums
    */
    function quick_reply($value, $key)
    {
        global $user;

        $radio_ary = array(1 => 'YES', 0 => 'NO');

        return h_radio('config[allow_quick_reply]', $radio_ary, $value) .
            '<br /><br /><input class="button2" type="submit" id="' . $key . '_enable" name="' . $key . '_enable" value="' . $user->lang['ALLOW_QUICK_REPLY_BUTTON'] . '" />';
    }


    /**
    * Select default dateformat
    */
    function dateformat_select($value, $key)
    {
        global $user, $config;

        // Let the format_date function operate with the acp values
        $old_tz = $user->timezone;
        $old_dst = $user->dst;

        $user->timezone = $config['board_timezone'] * 3600;
        $user->dst = $config['board_dst'] * 3600;

        $dateformat_options = '';

        foreach ($user->lang['dateformats'] as $format => $null)
        {
            $dateformat_options .= '<option value="' . $format . '"' . (($format == $value) ? ' selected="selected"' : '') . '>';
            $dateformat_options .= $user->format_date(time(), $format, false) . ((strpos($format, '|') !== false) ? $user->lang['VARIANT_DATE_SEPARATOR'] . $user->format_date(time(), $format, true) : '');
            $dateformat_options .= '</option>';
        }

        $dateformat_options .= '<option value="custom"';
        if (!isset($user->lang['dateformats'][$value]))
        {
            $dateformat_options .= ' selected="selected"';
        }
        $dateformat_options .= '>' . $user->lang['CUSTOM_DATEFORMAT'] . '</option>';

        // Reset users date options
        $user->timezone = $old_tz;
        $user->dst = $old_dst;

        return "<select name=\"dateoptions\" id=\"dateoptions\" onchange=\"if (this.value == 'custom') { document.getElementById('" . addslashes($key) . "').value = '" . addslashes($value) . "'; } else { document.getElementById('" . addslashes($key) . "').value = this.value; }\">$dateformat_options</select>
        <input type=\"text\" name=\"config[$key]\" id=\"$key\" value=\"$value\" maxlength=\"30\" />";
    }

    /**
    * Select multiple forums
    */
    function select_news_forums($value, $key)
    {
        global $user, $config;

        $forum_list = make_forum_select(false, false, true, true, true, false, true);

        // Build forum options
        $s_forum_options = '<select id="' . $key . '" name="' . $key . '[]" multiple="multiple">';
        foreach ($forum_list as $f_id => $f_row)
        {
            $f_row['selected'] = phpbb_optionget(1, $f_row['forum_options']);

            $s_forum_options .= '<option value="' . $f_id . '"' . (($f_row['selected']) ? ' selected="selected"' : '') . (($f_row['disabled']) ? ' disabled="disabled" class="disabled-option"' : '') . '>' . $f_row['padding'] . $f_row['forum_name'] . '</option>';
        }
        $s_forum_options .= '</select>';

        return $s_forum_options;
    }

    function select_exclude_forums($value, $key)
    {
        global $user, $config;

        $forum_list = make_forum_select(false, false, true, true, true, false, true);

        // Build forum options
        $s_forum_options = '<select id="' . $key . '" name="' . $key . '[]" multiple="multiple">';
        foreach ($forum_list as $f_id => $f_row)
        {
            $f_row['selected'] = phpbb_optionget(2, $f_row['forum_options']);

            $s_forum_options .= '<option value="' . $f_id . '"' . (($f_row['selected']) ? ' selected="selected"' : '') . (($f_row['disabled']) ? ' disabled="disabled" class="disabled-option"' : '') . '>' . $f_row['padding'] . $f_row['forum_name'] . '</option>';
        }
        $s_forum_options .= '</select>';

        return $s_forum_options;
    }

    function store_feed_forums($option, $key)
    {
        global $db, $cache;

        // Get key
        $values = request_var($key, array(0 => 0));

        // Empty option bit for all forums
        $sql = 'UPDATE ' . FORUMS_TABLE . '
            SET forum_options = forum_options - ' . (1 << $option) . '
            WHERE ' . $db->sql_bit_and('forum_options', $option, '<> 0');
        $db->sql_query($sql);

        // Already emptied for all...
        if (sizeof($values))
        {
            // Set for selected forums
            $sql = 'UPDATE ' . FORUMS_TABLE . '
                SET forum_options = forum_options + ' . (1 << $option) . '
                WHERE ' . $db->sql_in_set('forum_id', $values);
            $db->sql_query($sql);
        }

        // Empty sql cache for forums table because options changed
        $cache->destroy('sql', FORUMS_TABLE);
    }

}

?>